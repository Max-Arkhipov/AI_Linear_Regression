# AI_Linear_Regression
HW project ( 2024, ML course). With all sorts of linear models and FastApi service.

## Сервис развернут на render. 
## [Сcылка на сервис](https://linear-regression-cars.onrender.com/ "Сcылка на сервис") 
    - Данные для тестовых прогонов лежат в папке test_csv. 
    Это исходный тестовый датасет из задания и его кусочки. 
    Сами данные в датасете не были изменены.

## Результаты работы

### Предобработка данных и EDA

- В первую очередь был осуществлен первичный анализ данных: вывели различные части датасета, определили типы полей и наличие в них пропусков, вывели список полей с пропусками. Кроме того, с помощью библиотеки ydata_profiling создали отчет, вывели его на экран, сохрнили в файл profile_report.html.

- Далее была проведена обработка полей mileage, engine, max_power, torque: очистили их от единиц измерения и привели к числовым типам. При реализации были написаны функции с использованием методов обработки строк. 

- С признаком torque вышла забавная ситуация, сначала я его удалил, но после того, как получил неудовлетворительные метрики качества построенных моделей, решил с ним все-таки разобраться. Torque очень неприянтый признак, у него есть два значения с разными единицами
 измерения, которые еще и отличаются от строки к строке. Чтобы с ним разобраться, пишем отдельную функцию, которая преобразуют колонку в torque и max_torque_rpm с конвертированными и округленными данными для различных единиц измерения. 

- После заполнили пропуски в полях тренировочного и тестового датасета медианными значениями по столбцам тренировочного датасета. При реализации использовались функции и циклы.

- Удалили из тренировочного датасета объекты с одинаковым признаковым описанием, обновили индексы строк.

- Построили графики `pairplot` из библиотеки `seabron` для тренировочного и тестового датасета. Были сделаны следующие выводы:
    - На основе распределений можно предположить связь признаков с целевой переменной, в особенности сильную связь можно наблюдать для признаков: year, engine, max_power и km_driven. Связь признаков engine и max_power с целевой переменной скорее всего линейная. Зависимость между признаками year, km_driven и целевой переменной выглядит квадратичной.
    - На основе распределений можно выдвинуть гипотезу о корреляциях признаков: engine, mileage, max_power, seats.
      
- Построили тепловую карту `heatmap` из библиотеки `seabron` для отображения корреляций тренировочного датасета. Из тепловой карты следует, что наибольшая зависимость наблюдается между таргетом и признаком max_power. На тепловой карте подтверждается зависимость между признаками engine - seats, engine - max_power.

- Для того, чтобы сравнить распределения тестового и тренировочного набора данных построены дополнительные графики отображающие данные на одном графическом элементе, кроме того в анализ включены категориальные признаки. Некоторые выводы:
    - Данные на гистограмме позволяют предположить схожесть распределения признаков датасетов, однако для распределения автомобилей по году производства можно заметить, что в тренировочном датасете не представлены 2005, 2009 и 2015 годы выпуска автомобилей.
    - Данные, представленные на графике `kdeplot` библиотеки `seabron`, показывают высокую схожесть распределения признаков датасета.
    - При отображении на тепловой карте всех признаков модели можно заметить сильную корреляцию между наименованием марки автомобиля и таргетом

### Модель только на вещественных признаках

- Обучили классическую линейную регрессию. Получили результат:
    - Значение MSE для трейна:  116600313590.75081
    - Значение MSE для теста:   233001116120.28818
    - Значение R^2 для трейна:  0.593214521620734
    - Значение R^2 для теста:   0.5946598097210027
    - Модель далека от совершенства, предсказывает цену посредственно.

- Стандартизировали классическую линейную регрессию. Получили следующий результат:
    - Значение MSE для трейна:  116600313590.75055
    - Значение MSE для теста:   233001116120.28006
    - Значение R^2 для трейна:  0.5932145216207348
    - Значение R^2 для теста:   0.594659809721017
    - Каких-либо значимых изменений качества модели стандартизация не дала
    - Наиболее информативным оказался признак max_power.
    - Проведена стандартизация признаков, последующие модели на вещественных признаках обучаются на них.
      
- Обучили Lasso-регрессию:
    - Значение MSE для трейна:  116600313600.87555
    - Значение MSE для теста:   233001786510.72232
    - Значение R^2 для трейна:  0.5932145215854115
    - Значение R^2 для теста:   0.5946586434768635
    - Качество модели практически не изменилось
    - L1-регуляризация с параметрами по умолчанию не занулила никакие веса

- Перебором по сетке (c 10-ю фолдами) подобрали оптимальные параметры для Lasso-регрессии:
    - Получили: alpha = 55300
    - Значение MSE для трейна:  124199197326.72923
    - Значение MSE для теста:   268526387418.06036
    - Значение R^2 для трейна:  0.5667041679133009
    - Значение R^2 для теста:   0.5328583022118372
    - При регуляризации занулились веса следующих признаков: km_driven, mileage, engine, seats
      
- Перебором по сетке (c 10-ю фолдами) подобрали оптимальные параметры для ElasticNet-регрессии:
    - Получили: alpha = 0.76, l1_ratio = 0.49
    - Значение MSE для трейна:  126195023419.74557
    - Значение MSE для теста:   278928918851.4617
    - Значение R^2 для трейна:  0.5597412957990885
    - Значение R^2 для теста:   0.5147615473944854
    - Получаем: alpha = 0.96, l1_ratio=0.86 


### Добавляем категориальные фичи

- Кодируем категориальные фичи (и seats) методом OneHot-кодирования
- Перебираем параметр регуляризации alpha для гребневой (ridge) регрессии:
    - Получаем:
    - alpha = 3
    - Значение MSE для стандартизированного тесте:  214860632342.3589
    - Значение R^2 для стандартизированного тесте:  0.6262178866467067
    - Среднее кросс-валидации: 0.61708
    - Видим, что качество предсказаний улучшилось довольно заметно!

### Feature Engineering

- Добавляем полиминальные признаки второй степени

    - Значение MSE для теста:  101582475540.26753
    - Значение R^2 для теста:  0.823282134222711
    - Среднее кросс-валидации: 0.61708
- Пробуем работать с имеющимися признаками

    - Применяем Indicator Method. Добавляем столбец с индикатором пропусков в данных. Но для начала пройдемся по этапам предобработки данных заново, чтобы ничего не напутать.
    - После добавления индикаторов пропусков в данных пробуем эти самые пропуски заполнять нулями и медианами. Пытаемся уловить разницу.
    - Разница не обнаружена :(

        - При заполнении нулями:
            - Значение MSE для теста:  215700949843.863
            - Значение R^2 для теста:  0.62475602903149
            - Среднее кросс-валидации: 0.57693

        - При заполнении медианами:
            - Значение MSE для теста:  215700949843.85007
            - Значение R^2 для теста:  0.6247560290315124
            - Среднее кросс-валидации: 0.57691
    - Попробуем добавить One-hot кодирование к индикации пропусков:
        - Значение MSE для теста:  199746714082.18774
        - Значение R^2 для теста:  0.6525108014852616
    - Логаримфмируем целевую переменную
    - Добавим некоторые полиномильные признаки - логарифмируем признаки year, engine, km, torque (оба). Пробуем делить max_power на engine и engine на torque.
    - Смотрим что получилось:
        - Значение MSE для теста:  0.09308288320360683
        - Значение R^2 для теста:  0.8698700523438925
        - Среднее кросс-валидации: 0.83625
        - Круто! 
    - Попробуем все сложить, One-hot + Индикация пропусков + Полиноминальные признаки + Логаримфирование:
        - Значение MSE для теста:  0.08494149361736263
        - Значение R^2 для теста:  0.8812517217147107
        - Среднее кросс-валидации: 0.84147
        - Небольшой прирост, слишком много признаков
    - Откатимся немного назад и попробуем использовать марку машины. Их не так много, поэтому можно попробовать закодировать. Берем первое слово из признака name
    - В трейне не хватает производетелей Опель и Ашок. Брутфорсим :) 
    - Т.к. бренд Maruti представлен больше других в обоих частях датасета, изменим две строчки на нужные нам марки. Они не должны сильно повлиять на качество модели
        - Значение MSE для теста:  0.058073674602835176
        - Значение R^2 для теста:  0.9188129549045604
        - Среднее кросс-валидации: 0.88432
    - Пробуем дополнительно добавить полиноминальные признаки:
        - Значение MSE для теста:  0.05543276831864425
        - Значение R^2 для теста:  0.922504944072695
        - Среднее кросс-валидации: 0.88740
        - На этом закончим. Результат мне показался достаточного уровня.

### Решаем бизнес-задачу
- Не забываем убрать логарифм с предсказания и таргета
- Доля предиктов, отличающихся не более чем на 10% от реальной цены в тесте - 38%.

### Проделываем все от начала и до самого конца (получения итоговой модели)
- Страдаем, листая километровый ноутбук. Находим косяки, устраняем, собираем все в цельный пайплайн.

### Реализация сервиса FastAPI
- Проделываем слеудющее:
    - Средствами pydantic описываем класс базового объекта (заготовка)
    - Класс с коллецией объектов (заготовка)
    - Метод post, который получает на вход один объект описанного класса в формате json
    - Метод post, который получает на вход коллекцию объектов описанного класса в формате csv

- В процессе реализации сервиса я столкнулся с двумя вопросами по начинке поступающих на вход данных:
    - Что делать с пропусками (должны ли они быть)?
    - Что делать с признаком torque (должны быть две колонки на входе или делить на две уже внутри сервиса)?

- Мне хотелось, чтобы сервис умел работать с исходными данными, в том числе мог пережевывать тестовый датасет целиком.
    - Поэтому я решил заполнять пропуски в данных с помощью медиан, полученных на трейне в ноутбуке и экспортированных в .pickle файл.
    Не самое элегантное решение, но мне другого в голову не пришло. 
    - Со столбцом torque, соответственно такая ситуация: я ожидаю, что на 
    вход сервису будет поступать информация в изначальном виде, одной колонкой.

- В итоге на вход методу post, работающему с форматом csv, можно подавать тестовый датасет целиком (придется подождать) или частично
без какой-либо предобработки. 

### Картинки

![Изображение](https://github.com/gbull25/LinearRegression_HW/raw/main/pics/handle_1.png "Первая ручка")

![Изображение](https://github.com/gbull25/LinearRegression_HW/raw/main/pics/handle_2.png "Вторая ручка")
